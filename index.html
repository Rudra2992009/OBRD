<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OBRD : Hybrid Object Detection</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0e0e0e">
  <style>
    body {margin:0;background:#0e0e0e;color:#fff;font-family:Arial;text-align:center;}
    h1 {margin-top:20px;}
    video,canvas{border-radius:10px;width:90vw;max-width:720px;}
    canvas{position:absolute;top:0;left:0;}
    #camera-container{position:relative;display:inline-block;margin-top:20px;}
    #status{margin-top:10px;color:#00ff99;}
  </style>
</head>
<body>
  <h1>OBRD : Hybrid Object Detection</h1>

  <div id="camera-container">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas"></canvas>
  </div>

  <div id="status">Loadingâ€¦</div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/efficientdet"></script>

  <script>
    const video=document.getElementById('video');
    const canvas=document.getElementById('canvas');
    const ctx=canvas.getContext('2d');
    const status=document.getElementById('status');
    const cloudURL='http://localhost:8000/api/detect';
    let coco,effdet,mobile,stream;

    async function setupCamera(){
      if(stream)stream.getTracks().forEach(t=>t.stop());
      const c={video:{facingMode:{exact:'environment'},width:{ideal:1920},height:{ideal:1080}}};
      stream=await navigator.mediaDevices.getUserMedia(c).catch(()=>navigator.mediaDevices.getUserMedia({video:true}));
      video.srcObject=stream;
      return new Promise(r=>video.onloadedmetadata=()=>{canvas.width=video.videoWidth;canvas.height=video.videoHeight;r();});
    }

    async function localDetect(){
      const localPreds=[];
      if(coco)(await coco.detect(video)).forEach(p=>localPreds.push({class:p.class,score:p.score,bbox:p.bbox,src:'COCO'}));
      if(effdet)(await effdet.detect(video)).forEach(p=>localPreds.push({class:p.class,score:p.score,bbox:p.bbox,src:'EffDet'}));
      if(mobile)(await mobile.classify(video)).forEach(p=>localPreds.push({class:p.className,score:p.probability,bbox:[10,10,250,40],src:'MobileNet'}));
      return localPreds;
    }

    async function cloudDetect(frameBlob){
      try{
        const f=new FormData();f.append('frame',frameBlob);
        const res=await fetch(cloudURL,{method:'POST',body:f});
        return await res.json();
      }catch{ return []; }
    }

    async function detect(){
      const blob=new Blob([await (await fetch(video.srcObject)).arrayBuffer || new ArrayBuffer()],{type:'image/jpeg'});
      const [localPreds,cloudPreds]=await Promise.all([localDetect(),cloudDetect(blob)]);
      const all=[...localPreds,...cloudPreds];
      all.sort((a,b)=>b.score-a.score);
      ctx.clearRect(0,0,canvas.width,canvas.height);ctx.drawImage(video,0,0,canvas.width,canvas.height);
      all.slice(0,10).forEach(p=>{
        ctx.strokeStyle=p.src==='COCO'?'#00FF99':p.src==='EffDet'?'#00BFFF':p.src==='MobileNet'?'#FFA500':'#FF00FF';
        ctx.lineWidth=2;ctx.strokeRect(...p.bbox);
        ctx.font='16px Arial';ctx.fillStyle=ctx.strokeStyle;
        ctx.fillText(`${p.class} (${Math.round(p.score*100)}%) [${p.src}]`,p.bbox[0],p.bbox[1]>20?p.bbox[1]-5:20);
      });
      requestAnimationFrame(detect);
    }

    async function start(){
      await setupCamera();
      coco=await cocoSsd.load();
      effdet=await efficientdet.load({model:'lite0'});
      mobile=await mobilenet.load();
      status.textContent='Models loaded. Hybrid detection active.';
      detect();
    }

    if('serviceWorker' in navigator){navigator.serviceWorker.register('service-worker.js');}
    start();
  </script>
</body>
</html>
